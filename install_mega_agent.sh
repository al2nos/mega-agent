#!/bin/bash

set -euo pipefail

USER="${SUDO_USER:-$(whoami)}"
HOME_DIR="/home/$USER"
PROJECT_DIR="$HOME_DIR/mega-agent"

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"; }
info() { log "INFO: $*"; }
warn() { log "WARN: $*"; }
error() { log "ERROR: $*" >&2; }
fatal() { log "FATAL: $*" >&2; exit 1; }

check_system() {
    info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
    [[ $EUID -eq 0 ]] && fatal "–ù–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç root!"
    info "–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞"
}

install_dependencies() {
    info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    sudo apt update -q

    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ python3-dev –î–û pip
    sudo apt install -y --no-install-recommends \
        python3 python3-pip python3-venv python3-dev python3-full \
        build-essential cmake gcc \
        python3-rpi.gpio python3-spidev \
        || fatal "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
    sudo apt install -y --no-install-recommends \
        ca-certificates curl wget git \
        htop nano vim jq \
        alsa-utils pulseaudio espeak-ng \
        portaudio19-dev libasound2-dev \
        libportaudio2 libportaudiocpp0 \
        sqlite3 \
        ufw fail2ban \
        mosquitto mosquitto-clients \
        libavformat-dev libavfilter-dev \
        libavdevice-dev libavutil-dev \
        libswscale-dev libswresample-dev \
        libsndfile1-dev libffi-dev \
        python3-pil python3-pil.imagetk \
        fonts-dejavu-core fonts-freefont-ttf \
        spi-tools i2c-tools \
        python3-serial \
        || warn "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

setup_spi() {
    info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ SPI..."
    sudo groupadd -f spi 2>/dev/null || true
    sudo groupadd -f gpio 2>/dev/null || true
    sudo groupadd -f i2c 2>/dev/null || true
    sudo usermod -a -G spi,gpio,i2c,audio,video $USER
    # ... (–ª–æ–≥–∏–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è dtparam=spi=on –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    info "SPI –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
}

install_agent() {
    info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ–≥–∞-–∞–≥–µ–Ω—Ç–∞ –∏ –µ–≥–æ –º–æ–¥—É–ª–µ–π..."
    cd "$PROJECT_DIR"

    # –ö–õ–Æ–ß–ï–í–û–ô –ú–û–ú–ï–ù–¢: –°–æ–∑–¥–∞–Ω–∏–µ venv —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø–∞–∫–µ—Ç–∞–º
    python3 -m venv venv --system-site-packages
    source venv/bin/activate

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip –≤–Ω—É—Ç—Ä–∏ venv
    pip install --upgrade pip

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ requirements.txt
    if [[ -f "requirements.txt" ]]; then
        info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ requirements.txt"
        pip install -r requirements.txt
    else
        warn "–§–∞–π–ª requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ pip-–ø–∞–∫–µ—Ç–æ–≤"
    fi

    info "–ú–µ–≥–∞-–∞–≥–µ–Ω—Ç –∏ –º–æ–¥—É–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

setup_services() {
    # ... (–ª–æ–≥–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ systemd —Å–µ—Ä–≤–∏—Å–∞)
    info "–°–µ—Ä–≤–∏—Å—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
}

final_setup() {
    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    mkdir -p "$PROJECT_DIR"/{config,logs,models,backups,modules}
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ config/settings.json (–µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç)
    # ... (–ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞)

    info "–§–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
}

show_status() {
    echo ""
    echo "=========================================="
    echo "üöÄ MEGA-AGENT –ú–û–î–£–õ–ò –£–°–ü–ï–®–ù–û –£–°–¢–ê–ù–û–í–õ–ï–ù–´"
    echo "=========================================="
    echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:"
    echo "   ‚Ä¢ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø–∞–∫–µ—Ç–∞–º"
    echo "   ‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—á–µ—Ä–µ–∑ pip)"
    echo "   ‚Ä¢ –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã: python3-rpi.gpio, python3-spidev"
    echo "   ‚Ä¢ –ö–∞—Ä–∫–∞—Å –º–æ–¥—É–ª–µ–π –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ modules/"
    echo "   ‚Ä¢ –ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª"
    echo ""
    echo "üîß –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
    echo "   1. –†–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ –ª–æ–≥–∏–∫—É –≤ —Ñ–∞–π–ª–∞—Ö modules/*.py"
    echo "   2. –°–æ–∑–¥–∞–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∞–≥–µ–Ω—Ç (mega_agent.py)"
    echo "   3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ config/settings.json"
    echo "   4. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:"
    echo "      source ~/mega-agent/venv/bin/activate"
    echo "   5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–æ–¥—É–ª—è–º:"
    echo "      python3 -c \"import RPi.GPIO; import spidev; print('GPIO –∏ SPI –¥–æ—Å—Ç—É–ø–Ω—ã')\""
    echo "=========================================="
}

main() {
    info "–ù–∞—á–∞–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–µ–≥–∞-–∞–≥–µ–Ω—Ç–∞ (–º–æ–¥—É–ª–∏)..."
    mkdir -p "$PROJECT_DIR"
    cd "$PROJECT_DIR"
    check_system
    install_dependencies
    setup_spi
    install_agent
    setup_services
    final_setup
    show_status
    info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞! ü§ñ"
}

main "$@"
